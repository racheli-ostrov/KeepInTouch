name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # 1. הורדת הקוד מה-Repository
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. התחברות ל-Docker Hub (משתמש ב-Secrets שהגדרנו)
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 3. בניית ה-Image של ה-Backend
    # שים לב: כאן אנחנו בונים את האימג' כדי שנוכל להריץ עליו טסטים
    - name: Build Backend Image
      run: |
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/airtouch-backend:latest ./backend

    # 4. הרצת ה-Unit Tests (ה-CI)
    # אנחנו מריצים את pytest בתוך הקונטיינר שבנינו עכשיו
    - name: Run Backend Tests
      run: |
        docker run --rm \
          -e GEMINI_API_KEY="dummy_key" \
          -e PYTHONPATH=/app \
          -e SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt \
          -e REQUESTS_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt \
          ${{ secrets.DOCKERHUB_USERNAME }}/airtouch-backend:latest \
          python -m pytest
    # 5. דחיפת ה-Image ל-Docker Hub (ה-CD)
    # השלב הזה יתבצע רק אם הטסטים עברו בהצלחה
    - name: Push Image to Docker Hub
      if: github.event_name == 'push' && success()
      run: |
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/airtouch-backend:latest

    - name: Build Extension with Docker
      run: |
        # בונים את האימג' רק כדי להפיק ממנו את הקבצים
        docker build -t temp-extension ./extension
        # יוצרים קונטיינר זמני כדי להעתיק ממנו את התיקייה הבנויה (למשל תיקיית dist או build)
        docker create --name temp-container temp-extension
        docker cp temp-container:/app/dist ./extension-build
        docker rm temp-container

    - name: Upload Extension Artifact
      uses: actions/upload-artifact@v4
      with:
        name: airtouch-extension-ready
        path: ./extension-build/

    - name: Trigger Render Deploy
      if: success()
      run: |
        curl -X GET "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"